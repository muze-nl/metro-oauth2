let e;var t=require("@muze-nl/metro"),o=require("@muze-nl/assert"),r=require("@muze-nl/metro/src/mw/json.mjs");function n(e){Object.defineProperty(e,"__esModule",{value:!0,configurable:!0})}function s(e,t,o,r){Object.defineProperty(e,t,{get:o,set:r,enumerable:!0,configurable:!0})}var a={};function i(e){let n,s,a="default";if(e.site&&(a=e.site),"undefined"!=typeof localStorage)n={get:()=>localStorage.getItem("metro/state:"+a),has:()=>localStorage.getItem("metro/state:"+a),set:e=>localStorage.setItem("metro/state:"+a,e)},s={get:e=>localStorage.getItem(a+":"+e),set:(e,t)=>localStorage.setItem(a+":"+e,t),has:e=>localStorage.hasItem(a+":"+e)};else{let e=new Map;n={get:()=>e.get("metro/state:"+a),has:()=>e.get("metro/state:"+a),set:t=>e.set("metro/state:"+a,t)},s=new Map}let i={tokens:s,state:n,endpoints:{authorize:"/authorize",token:"/token"},callbacks:{authorize:e=>document.location=e},client:t.client().with((r&&r.__esModule?r.default:r)()),client_id:"",client_secret:"",redirect_uri:"",grant_type:"authorization_code",force_authorization:!1};for(let o in e){switch(o){case"access_token":case"authorization_code":case"refresh_token":i.tokens.set(o,e[o]);break;case"client":case"client_id":case"client_secret":case"grant_type":case"force_authorization":case"redirect_uri":i[o]=e[o];break;case"state":case"tokens":if("function"==typeof e[o].set&&"function"==typeof e[o].get&&"function"==typeof e[o].has)i[o]=e[o];else if("tokens"==o&&"object"==typeof e.tokens)for(let t in e.tokens)i.tokens.set(t,e.tokens[t]);else if("state"==o&&"object"==typeof e.state)e.state.random||(e.state.random=d(40)),i.state.set(JSON.stringify(e.state));else throw t.metroError("metro/mw/oauth2: incorrect value for "+o);break;case"endpoints":for(let o in e.endpoints)if("authorize"!=o&&"token"!=o)throw t.metroError('Unknown endpoint, choose one of "authorize" or "token"',o);Object.assign(i.endpoints,e.endpoints);break;case"callbacks":for(let o in e.callbacks)if("authorize"!=o)throw t.metroError('Unknown callback, choose one of "authorize"',o);Object.assign(i.callbacks,e.callbacks);break;default:throw t.metroError("Unknown oauth2mw option ",o)}i.redirect_uri||(i.redirect_uri="undefined"!=typeof window?window.location?.href:""),i.redirect_uri&&(i.redirect_uri=t.url(i.redirect_uri).with("?metroRedirect=true"))}return async function(e,t){if(i.force_authorization)return c(e,t);let o=await t(e);if(o.ok)return o;switch(o.status){case 400:case 401:return c(e,t)}return o};async function c(e,o){if(function(){if("undefined"!=typeof window&&window?.location){let e,o,r,n=t.url(window.location);if(n.searchParams.has("code")?(r=n.searchParams,n=n.with({search:""}),history.pushState({},"",n.href)):n.hash&&(r=new URLSearchParams("?"+n.hash.substr(1)),n=n.with({hash:""}),history.pushState({},"",n.href)),r){e=r.get("code"),o=r.get("state");let t=i.state.get("metro/state");if(!o||o!==t)return;e&&i.tokens.set("authorization_code",e)}}}(),i.tokens.has("access_token")){if(function(e){if(e.oauth2&&e.oauth2.tokens&&e.oauth2.tokens.has("access_token")){let t=new Date,o=e.oauth2.tokens.get("access_token");return t.getTime()>o.expires.getTime()}return!1}(e))return await u(e)?c(e,o):t.response("false");{let r=i.tokens.get("access_token");return o(e=t.request(e,{headers:{Authorization:r.type+" "+r.value}}))}}return await l(e)?c(e,o):t.response("false")}async function l(e){if("authorization_code"===i.grant_type&&!i.tokens.has("authorization_code")){let e=function(){if(!i.endpoints.authorize)throw t.metroError("oauth2mw: Missing options.endpoints.authorize url");let e=t.url(i.endpoints.authorize,{hash:""});o.assert(i,{client_id:/.+/,redirect_uri:/.+/,scope:/.*/});let r={response_type:"code",client_id:i.client_id,redirect_uri:i.redirect_uri,state:i.state||d(40)};return r.client_secret=i.client_secret,i.scope&&(r.scope=i.scope),t.url(e,{search:r})}();if(!i.callbacks.authorize||"function"!=typeof i.callbacks.authorize)throw t.metroError("oauth2mw: oauth2 with grant_type:authorization_code requires a callback function in client options.oauth2.callbacks.authorize");let r=await i.callbacks.authorize(e);if(!r)return t.response(!1);i.tokens.set("authorization_code",r)}let r=h(),n=await i.client.get(r);if(!n.ok)throw t.metroError(n.status+":"+n.statusText,await n.text());let s=await n.json();if(i.tokens.set("access_token",{value:s.access_token,expires:_(s.expires_in),type:s.token_type,scope:s.scope}),s.refresh_token){let e={value:s.refresh_token};i.tokens.set("refresh_token",e)}return s}async function u(e,o){let r=h("refresh_token"),n=await i.client.get(r);if(!n.ok)throw t.metroError(n.status+":"+n.statusText,await n.text());let s=await n.json();if(i.tokens.set("access_token",{value:s.access_token,expires:_(s.expires_in),type:s.token_type,scope:s.scope}),s.refresh_token){let e={value:s.refresh_token};i.tokens.set("refresh_token",e)}return s}function d(e){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o="",r=0;for(;r<e;)o+=t.charAt(Math.floor(Math.random()*t.length)),r++;return i.state.set(o),o}function h(e=null){if(o.assert(i,{client_id:/.+/,redirect_uri:/.+/}),!i.endpoints.token)throw t.metroError("oauth2mw: Missing options.endpoints.token url");let r=t.url(i.endpoints.token,{hash:""}),n={grant_type:e||i.grant_type,client_id:i.client_id};switch(n.client_secret=i.client_secret,i.scope&&(n.scope=i.scope),i.grant_type){case"authorization_code":n.redirect_uri=i.redirect_uri,n.code=i.tokens.get("authorization_code");break;case"client_credentials":break;case"refresh_token":n.refresh_token=i.refresh_token;break;default:throw Error("Unknown grant_type: ".oauth2.grant_type)}return t.url(r,{searchParams:n})}function _(e){if(e instanceof Date)return new Date(e.getTime());if("number"==typeof e){let t=new Date;return t.setSeconds(t.getSeconds()+e),t}throw TypeError("Unknown expires type "+e)}}n(a),s(a,"default",()=>i);var c={};n(c),s(c,"default",()=>h);const l={status:200,statusText:"OK",headers:{"Content-Type":"application/json"}},u=e=>({status:400,statusText:"Bad Request",headers:{"Content-Type":"application/json"},body:JSON.stringify({error:"invalid_request",error_description:e})});let d={};function h(r={}){return r=Object.assign({},{PKCE:!1,DPoP:!1},r),(r,n)=>{let s=t.url(r.url);switch(s.pathname){case"/authorize/":if(e=o.fails(s.searchParams,{response_type:"code",client_id:"mockClientId",state:o.Optional(/.*/)}))return t.response(u(e));if(s.searchParams.has("code_challenge")){if(!s.searchParams.has("code_challenge_method"))return t.response(u("missing code_challenge_method"));d.code_challenge=s.searchParams.get("code_challenge"),pcke.code_challenge_method=s.searchParams.get("code_challenge_method")}return t.response(l,{body:JSON.stringify({code:"mockAuthorizeToken",state:s.searchParams.get("state")})});case"/token/":if(e=o.fails(s.searchParams,{grant_type:o.oneOf("refresh_token","authorization_code")}))return t.response(u(e));switch(s.searchParams.grant_type){case"refresh_token":if(e=o.fails(s.searchParams,o.oneOf({refresh_token:"mockRefreshToken",client_id:"mockClientId",client_secret:"mockClientSecret"},{refresh_token:"mockRefreshToken",client_id:"mockClientId",code_verifier:/.+/})))return t.response(u(e));break;case"access_token":if(e=o.fails(s.searchParams,o.oneOf({client_id:"mockClientId",client_secret:"mockClientSecret"},{client_id:"mockClientId",code_challenge:/.*/,code_challenge_method:"S256"})))return t.response(u(e))}return t.response(l,{body:JSON.stringify({access_token:"mockAccessToken",token_type:"mockExample",expires_in:3600,refresh_token:"mockRefreshToken",example_parameter:"mockExampleValue"})});case"/protected/":let a=r.headers.get("Authorization"),[i,c]=a?a.split(" "):[];if(!c||"mockAccessToken"!==c)return t.response({status:401,statusText:"Forbidden",body:"401 Forbidden"});return t.response(l,{body:JSON.stringify({result:"Success"})});case"/public/":return t.response(l,{body:JSON.stringify({result:"Success"})});default:return t.response({status:404,statusText:"not found",body:"404 Not Found "+s})}}}var _={};function p(e){let o={code_verifier:"",endpoints:{authorize:"/authorize",token:"/token"}};return e?.endpoints?.authorize&&(o.endpoints.authorize=e.endpoints.authorize),e?.endpoints?.token&&(o.endpoints.token=e.endpoints.token),e.code_verifier?o.code_verifier=e.code_verifier:o.code_verifier=crypto.randomBytes(64).toString("hex"),async function(n,s){return n.url=t.url(n.url),n.url.pathname==o.endpoints.authorize?(n.url.searchParams.set("code_challenge",r(e.code_verifier)),n.url.searchParams.set("code_challend_method","S256"),n.url.searchParams.delete("client_secret")):n.url.pathname==o.endpoints.token&&(n.url.searchParams.set("code_verifier",o.code_verifier),n.url.searchParams.delete("client_secret")),await s(n)};async function r(e){return await globalThis.crypto.subtle.digest("SHA-256",btoa(Array.from(new Uint8Array(e),e=>String.fromCharCode(e)).join("")).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""))}}n(_),s(_,"default",()=>p);var f={};n(f),s(f,"default",()=>w);const k=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","ES512"],m=["client_secret_post","client_secret_base","client_secret_jwt","private_key_jwt"],g={issuer:(0,o.Required)(validURL),authorization_endpoint:(0,o.Required)(validURL),token_endpoint:(0,o.Required)(validURL),jwks_uri:(0,o.Optional)(validURL),registration_endpoint:(0,o.Optional)(validURL),scopes_supported:(0,o.Recommended)([]),response_types_supported:(0,o.Required)((0,o.anyOf)("code","token")),response_modes_supported:(0,o.Optional)([]),grant_types_supported:(0,o.Optional)([]),token_endpoint_auth_methods_supported:(0,o.Optional)([]),token_endpoint_auth_signing_alg_values_supported:(0,o.Optional)([]),service_documentation:(0,o.Optional)(validURL),ui_locales_supported:(0,o.Optional)([]),op_policy_uri:(0,o.Optional)(validURL),op_tos_uri:(0,o.Optional)(validURL),revocation_endpoint:(0,o.Optional)(validURL),revocation_endpoint_auth_methods_supported:(0,o.Optional)(m),revocation_endpoint_auth_signing_alg_values_supported:(0,o.Optional)(k),introspection_endpoint:(0,o.Optional)(validURL),introspection_endpoint_auth_methods_supported:(0,o.Optional)(m),introspection_endpoint_auth_signing_alg_values_supported:(0,o.Optional)(k),code_challendge_methods_supported:(0,o.Optional)([])};function w(e={}){e=Object.assign({},{client:t.client()},e),(0,o.assert)(e,{issuer:(0,o.Required)(validURL)}),y(e.issuer),e.client.with(e.issuer)}async function y(e){let r=options.client.get(t.url(e,".wellknown/oauth_authorization_server"));if(r.ok){(0,o.assert)(r.headers.get("Content-Type"),/application\/json.*/);let e=await r.json();return(0,o.assert)(e,g),e}throw t.metroError("metro.oidcmw: Error while fetching "+e+".wellknown/oauth_authorization_server",r)}globalThis.oauth2=a,globalThis.oauth2.mockserver=c,globalThis.oauth2.pkce=_,globalThis.oauth2.discovery=f;
//# sourceMappingURL=browser.js.map
